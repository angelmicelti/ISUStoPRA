<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISUStoPRA — Extractor y generador PRA</title>
	<link rel="manifest" href="/manifest.json">
	<meta name="theme-color" content="#2563eb">
	<link rel="icon" href="/icons/icon-192.png">

  <!-- Tailwind, Font Awesome, PDF.js, jsPDF -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap">

  <style>
    :root { --header-h: 64px; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans';
      background:
        radial-gradient(1000px 600px at 90% -100%, #e0f2fe 0%, transparent 60%),
        radial-gradient(1200px 800px at -20% 120%, #e9d5ff 0%, transparent 60%),
        linear-gradient(180deg, #ffffff, #f8fafc);
    }

    /* Drag-over feedback */
    .drop-zone { transition: all 0.25s ease; }
    .drop-zone.dragover {
      border-color: #2563eb;
      background-color: rgba(37, 99, 235, 0.06);
      transform: translateY(-1px);
    }

    /* Simple loader */
    .loader {
      border: 4px solid rgba(148,163,184,.25);
      border-top: 4px solid #2563eb;
      border-radius: 9999px;
      width: 30px; height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Selection feedback */
    .filter-button.active { background-color: #2563eb !important; color: #fff !important; box-shadow: 0 8px 20px rgba(37,99,235,.25); }
    .evaluation-item.selected { border-color: #2563eb !important; background-color: #eff6ff !important; box-shadow: 0 0 0 2px rgba(37,99,235,.35) inset; }
    .recovery-criterion-item.selected { background-color: #e0f2fe !important; border-left-color: #1d4ed8 !important; box-shadow: 0 0 0 2px rgba(37,99,235,.35) inset; font-weight: 600; }

    /* Criterion nodes */
    .criterion-node { border: 1px solid; border-radius: 12px; padding: 12px; margin: 8px 0; font-size: .92rem; transition: transform .15s ease, box-shadow .15s ease; }
    .criterion-node:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(2,8,23,.06); }
    .criterion-node.cyr { background-color: #ecfdf5; border-color: #34c759; }
    .criterion-node.tyd { background-color: #eef2ff; border-color: #3b82f6; }
    .criterion-node.tec4 { background-color: #f5f3ff; border-color: #8b5cf6; }

    /* Accordion */
    .accordion-content { transition: all .25s ease; overflow: hidden; }

    /* Additional fields sections */
    .additional-field-section { padding: 1rem; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 1rem; background: rgba(255,255,255,.65); backdrop-filter: blur(4px); }
    .additional-field-item { display: flex; gap: .75rem; padding: .5rem; border-radius: .5rem; transition: background-color .15s ease; }

    .section-actividades { background-color: #f0fdf4; border-left: 5px solid #22c55e; }
    .section-actividades h3 { color: #15803d; }
    .section-actividades .additional-field-item:hover { background-color: #dcfce7; }

    .section-acceso { background-color: #fefce8; border-left: 5px solid #eab308; }
    .section-acceso h3 { color: #a16207; }
    .section-acceso .additional-field-item:hover { background-color: #fef9c3; }

    .section-recursos { background-color: #fdf4ff; border-left: 5px solid #c026d3; }
    .section-recursos h3 { color: #86198f; }
    .section-recursos .additional-field-item:hover { background-color: #fae8ff; }

    .section-agrupamientos { background-color: #f8fafc; border-left: 5px solid #64748b; }
    .section-agrupamientos h3 { color: #475569; }
    .section-agrupamientos .additional-field-item:hover { background-color: #f1f5f9; }

    .section-evaluacion { background-color: #fff7ed; border-left: 5px solid #f97316; }
    .section-evaluacion h3 { color: #c2410c; }
    .section-evaluacion .additional-field-item:hover { background-color: #ffedd5; }

    .tareas-textarea-container, .otros-textarea-container { margin-left: 1.5rem; margin-top: .5rem; display: none; }
    .tareas-textarea-container.show, .otros-textarea-container.show { display: block; }

    /* Subject color backgrounds */
    .cyr-1 { background-color: #ecfdf5; border-left: 4px solid #34c759; }
    .cyr-2 { background-color: #d1fae5; border-left: 4px solid #2daa4c; }
    .cyr-3 { background-color: #a7f3d0; border-left: 4px solid #268d3f; }
    .cyr-4 { background-color: #6ee7b7; border-left: 4px solid #1f7032; }

    .tyd-1 { background-color: #eef2ff; border-left: 4px solid #3b82f6; }
    .tyd-2 { background-color: #e0e7ff; border-left: 4px solid #2563eb; }
    .tyd-3 { background-color: #c7d2fe; border-left: 4px solid #1e40af; }
    .tyd-4 { background-color: #a5b4fc; border-left: 4px solid #1e3a8a; }

    .tec4 { background-color: #f5f3ff; border-left: 4px solid #8b5cf6; }

    .accordion-header-cyr { background-color: #f8fafc; }
    .accordion-content-cyr { background-color: #ecfdf5; }
    .accordion-header-tyd { background-color: #f8fafc; }
    .accordion-content-tyd { background-color: #eef2ff; }
    .accordion-header-tec4 { background-color: #f8fafc; }
    .accordion-content-tec4 { background-color: #f5f3ff; }

    /* Bottom nav behaviour */
    .bottom-nav {
      transition: all .25s ease;
      transform: translateY(100%);
      opacity: 0;
      padding-top: .4rem;
      padding-bottom: .4rem;
      backdrop-filter: blur(8px);
    }
    .bottom-nav.visible,
    .bottom-nav.always-visible {
      transform: translateY(0);
      opacity: 1;
    }
    #bottomNav > div { display: flex; align-items: center; min-height: auto; }
    #bottomNav button { padding-top: .45rem !important; padding-bottom: .45rem !important; }

    /* Mobile-friendly tweaks */
    @media (max-width: 768px) {
      .mobile-padding { padding-bottom: 88px; }
      .mobile-text-sm { font-size: .9rem; }
      .mobile-p-3 { padding: .75rem; }
      .mobile-py-2 { padding-top: .5rem; padding-bottom: .5rem; }
      #bottomNav button { font-size: .9rem; }
    }

    /* iOS safe area */
    @supports(padding: max(0px)) {
      .safe-area-bottom { padding-bottom: max(.5rem, env(safe-area-inset-bottom)); }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; }
    }

    /* Dark mode (auto) */
    @media (prefers-color-scheme: dark) {
      .dark-mode-compatible { background-color: #111827; color: #e5e7eb; }
      body { background: linear-gradient(180deg, #0b1020, #0b1020) !important; }
    }
  </style>
</head>

<body class="min-h-screen text-slate-800 mobile-padding">
  <!-- Header -->
  <header class="shadow-sm sticky top-0 z-50">
    <div class="bg-gradient-to-r from-blue-600 via-indigo-600 to-violet-600 text-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-[var(--header-h)] flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="bg-white/15 text-white p-2 rounded-lg"><i class="fa-solid fa-file-pdf text-xl"></i></div>
          <h1 class="text-lg md:text-xl font-bold tracking-tight">ISUStoPRA</h1>
        </div>
        <div class="text-sm opacity-90 hidden sm:block">
          <span id="headerScreenTitle">Paso 1: Carga y Consolidación</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Help modal -->
  <div id="helpModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
    <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-2xl max-w-2xl w-full max-h-[92vh] overflow-y-auto dark-mode-compatible">
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-t-2xl flex justify-between items-center">
        <h2 class="text-xl font-bold">Ayuda — ISUStoPRA</h2>
        <button onclick="closeHelp()" class="text-white hover:text-blue-200 text-2xl">&times;</button>
      </div>
      <div class="p-6 space-y-4">
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
          <h3 class="font-bold text-blue-800 mb-2 flex items-center gap-2"><i class="fa-solid fa-circle-info"></i> ¿Qué es ISUStoPRA?</h3>
          <p class="text-blue-700 text-sm">Genera Programas de Refuerzo del Aprendizaje (PRA) a partir de informes LOMLOE (PDF), consolidando criterios, perfiles y actividades.</p>
        </div>

        <div>
          <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2"><i class="fa-solid fa-play text-green-600"></i> Paso 1: Carga y Consolidación</h3>
          <ul class="text-sm text-slate-600 space-y-2 ml-6 list-disc">
            <li><span class="font-semibold">Carga PDFs:</span> arrastra o haz clic para cargar informes del mismo alumno</li>
            <li><span class="font-semibold">Selecciona evaluaciones:</span> haz clic en cada evaluación para incluirla</li>
            <li><span class="font-semibold">Filtra criterios:</span> todos, aprobados, suspensos o no evaluados</li>
            <li><span class="font-semibold">Exporta datos:</span> JSON o CSV</li>
          </ul>
        </div>

        <div>
          <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2"><i class="fa-solid fa-user-tag text-blue-600"></i> Paso 2: Plan de Mejora</h3>
          <ul class="text-sm text-slate-600 space-y-2 ml-6 list-disc">
            <li><span class="font-semibold">Perfil:</span> elige según pendientes o repetición</li>
            <li><span class="font-semibold">Revisa criterios:</span> organiza por materia</li>
            <li><span class="font-semibold">Selecciona refuerzo:</span> marca los criterios clave</li>
          </ul>
        </div>

        <div>
          <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2"><i class="fa-solid fa-list-check text-purple-600"></i> Paso 3: Plan de Recuperación</h3>
          <ul class="text-sm text-slate-600 space-y-2 ml-6 list-disc">
            <li><span class="font-semibold">TEC4:</span> muestra criterios relacionados para repetidores</li>
            <li><span class="font-semibold">Actividades:</span> define acciones específicas de refuerzo</li>
          </ul>
        </div>

        <div>
          <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2"><i class="fa-solid fa-gears text-orange-600"></i> Paso 4: Otros Aspectos a Trabajar</h3>
          <ul class="text-sm text-slate-600 space-y-2 ml-6 list-disc">
            <li><span class="font-semibold">Estrategias:</span> metodologías, recursos, agrupamientos</li>
            <li><span class="font-semibold">Tareas:</span> detalla en “Tareas (precisar)”</li>
            <li><span class="font-semibold">Otros recursos:</span> usa “Otros (especificar)”</li>
          </ul>
        </div>

        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
          <h3 class="font-bold text-yellow-800 mb-2 flex items-center gap-2"><i class="fa-solid fa-lightbulb"></i> Consejos clave</h3>
          <ul class="text-sm text-yellow-700 space-y-1 ml-6 list-disc">
            <li>Solo PDFs del mismo alumno</li>
            <li>Detecta duplicados automáticamente</li>
            <li>Detecta repetición (TEC4 + cursos inferiores)</li>
            <li>Avanza entre pantallas para guardar progreso</li>
          </ul>
        </div>

        <div class="text-center pt-2">
          <button onclick="closeHelp()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold">Entendido, ¡empecemos!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Validation modal -->
  <div id="validationModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
      <div class="bg-red-600 text-white p-4 rounded-t-2xl flex justify-between items-center">
        <h2 class="text-xl font-bold">Validación requerida</h2>
        <button onclick="closeValidationModal()" class="text-white hover:text-red-200 text-2xl">&times;</button>
      </div>
      <div class="p-6 space-y-4">
        <div class="flex items-start gap-3">
          <i class="fa-solid fa-triangle-exclamation text-red-500 text-xl mt-1"></i>
          <div>
            <div id="validationMessage" class="text-slate-700 mb-3">Se han marcado 0 ítems en la subsección.</div>
            <p class="text-slate-600 text-sm">Selecciona al menos un ítem en cada subsección antes de generar el PRA.</p>
          </div>
        </div>
        <div class="text-center pt-2">
          <button onclick="closeValidationModal()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold">
            Entendido
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8 max-w-7xl">
    <!-- Screen 1 -->
    <div id="screen1" class="flex flex-col lg:flex-row gap-6">
      <!-- Left column -->
      <div class="w-full lg:w-1/3 space-y-6">
        <div id="uploadSection" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-slate-200 p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-slate-800">Cargar evaluación</h2>
            <button onclick="showHelp()" class="text-blue-600 hover:text-blue-800" title="Ayuda">
              <i class="fa-solid fa-circle-question text-xl"></i>
            </button>
          </div>
          <p class="text-slate-500 text-sm mb-3">Añade informes PDF (solo del mismo alumno)</p>

          <div id="dropZone"
               class="drop-zone border-2 border-dashed border-slate-300 rounded-xl p-8 flex flex-col items-center justify-center cursor-pointer bg-white/65 hover:bg-blue-50 transition-all">
            <input type="file" id="fileInput" class="hidden" accept=".pdf" multiple>
            <div class="mb-2 text-blue-600"><i class="fa-solid fa-file-circle-plus text-4xl"></i></div>
            <p class="text-md font-semibold text-slate-700">Arrastra o haz clic para cargar</p>
          </div>

          <div id="errorMessage" class="hidden mt-4 p-3 bg-red-50 text-red-700 rounded-lg border border-red-200 text-sm flex items-center gap-3">
            <i class="fa-solid fa-circle-exclamation"></i><span id="errorText">Error procesando el archivo.</span>
          </div>
          <div id="loadingState" class="hidden flex-col items-center justify-center mt-4">
            <div class="loader mb-2"></div>
            <p class="text-slate-600 text-sm">Analizando PDF...</p>
          </div>
        </div>

        <div id="loadedEvaluationsSection" class="bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-slate-200 overflow-hidden hidden">
          <div class="bg-slate-100 px-4 py-3 border-b border-slate-200 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-table-list text-blue-600"></i>
              <h3 class="font-bold text-slate-800 text-lg">Evaluaciones (<span id="evalCount">0</span>)</h3>
            </div>
            <button onclick="clearAllData()" class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center gap-1">
              <i class="fa-solid fa-trash-can"></i> Borrar todo
            </button>
          </div>
          <div id="evaluationsList" class="divide-y divide-slate-100 max-h-96 overflow-y-auto"></div>
          <div class="bg-slate-50 p-3 text-sm text-slate-600 border-t border-slate-200 font-medium">
            Clic en la fila para seleccionar. Papelera para borrar.
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="w-full lg:w-2/3 space-y-6">
        <div id="initialMessage" class="flex flex-col items-center justify-center py-16 md:py-20 bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-slate-200">
          <i class="fa-solid fa-file-pdf text-6xl text-slate-300 mb-4"></i>
          <h3 class="text-xl font-semibold text-slate-700">Esperando informes PDF</h3>
          <p class="text-slate-500 text-sm">Carga y selecciona archivos para empezar a consolidar los criterios.</p>
          <button onclick="showHelp()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
            <i class="fa-solid fa-circle-question"></i> Ver ayuda
          </button>
        </div>

        <div id="resultsSection" class="hidden space-y-6">
          <div class="flex flex-col sm:flex-row justify-between items-center gap-4 bg-white/80 p-4 rounded-2xl shadow-sm border border-slate-200">
            <div class="text-sm font-medium text-slate-600 flex items-center gap-2">
              <i class="fa-solid fa-eye text-blue-600"></i>
              Consolidando: <span id="currentSelectionCount" class="font-bold text-slate-800">0 Materias</span>
            </div>
            <div class="flex gap-2">
              <button onclick="exportJSON()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                <i class="fa-solid fa-code"></i> JSON
              </button>
              <button onclick="exportCSV()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2">
                <i class="fa-solid fa-file-csv"></i> CSV
              </button>
            </div>
          </div>

          <div class="bg-white/80 rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex items-center gap-2">
              <i class="fa-solid fa-user-graduate text-blue-600"></i>
              <h3 class="font-bold text-slate-800">Datos del alumno</h3>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wider mb-1">Alumno/a</p>
                <p id="resName" class="text-lg font-medium text-slate-900">-</p>
              </div>
              <div>
                <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wider mb-1">Materia/s consolidadas</p>
                <p id="resSubject" class="text-lg font-medium text-slate-900">-</p>
              </div>
              <div>
                <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wider mb-1">Curso</p>
                <div class="flex items-center gap-2">
                  <span id="resCourse" class="text-lg font-bold text-blue-600">-</span>
                </div>
              </div>
            </div>
          </div>

          <div id="filterButtonsContainer" class="flex flex-wrap gap-2 bg-white/80 p-4 rounded-2xl shadow-sm border border-slate-200">
            <button id="filterAll" onclick="filterCriteria('all', this)"
                    class="filter-button px-3.5 py-2 rounded-lg text-sm font-semibold bg-blue-100 text-blue-700 hover:bg-blue-200 active">
              <i class="fa-solid fa-grip-lines"></i> Todos
            </button>
            <button id="filterApproved" onclick="filterCriteria('approved', this)"
                    class="filter-button px-3.5 py-2 rounded-lg text-sm font-semibold bg-emerald-100 text-emerald-700 hover:bg-emerald-200">
              <i class="fa-solid fa-circle-check"></i> Aprobados
            </button>
            <button id="filterFailed" onclick="filterCriteria('failed', this)"
                    class="filter-button px-3.5 py-2 rounded-lg text-sm font-semibold bg-rose-100 text-rose-700 hover:bg-rose-200">
              <i class="fa-solid fa-circle-xmark"></i> Suspensos
            </button>
            <button id="filterUnevaluated" onclick="filterCriteria('unevaluated', this)"
                    class="filter-button px-3.5 py-2 rounded-lg text-sm font-semibold bg-slate-100 text-slate-700 hover:bg-slate-200">
              <i class="fa-solid fa-circle-question"></i> No evaluados
            </button>
          </div>

          <div class="bg-white/80 rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex items-center justify-between">
              <div class="flex items-center gap-2"><i class="fa-solid fa-list-check text-blue-600"></i>
                <h3 class="font-bold text-slate-800">Criterios consolidados</h3>
              </div>
              <span id="criteriaCount" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-full">0 Criterios</span>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr class="bg-slate-50 text-slate-600 text-xs uppercase tracking-wider border-b border-slate-200">
                    <th class="px-6 py-3 font-semibold w-32">Código</th>
                    <th class="px-6 py-3 font-semibold">Enunciado del criterio</th>
                    <th class="px-6 py-3 font-semibold w-32 text-right">Calificación</th>
                  </tr>
                </thead>
                <tbody id="resultsTableBody" class="divide-y divide-slate-100 text-sm"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Screen 2 -->
    <div id="screen2" class="hidden flex flex-col items-center justify-center pt-8 md:pt-10">
      <div class="w-full max-w-4xl bg-white/85 rounded-2xl shadow-xl border border-slate-200 p-6 md:p-8 space-y-6">
        <div class="text-center">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-1">Paso 2: Plan de mejora y recuperación</h2>
          <p class="text-slate-500 mobile-text-sm">Selecciona el perfil del alumno y los criterios a reforzar.</p>
        </div>

        <div id="studentProfileContainer" class="bg-slate-50 p-4 md:p-5 rounded-xl border border-slate-200 shadow-sm">
          <h3 class="text-sm font-bold text-slate-700 mb-4 uppercase tracking-wider flex items-center gap-2">
            <i class="fa-solid fa-user-tag text-blue-600"></i> Perfil del alumnado
          </h3>
          <div id="profileWarning" class="hidden mb-4 p-3 bg-yellow-50 text-yellow-800 border border-yellow-200 rounded-lg text-sm flex items-start gap-3">
            <i class="fa-solid fa-triangle-exclamation mt-0.5"></i>
            <div><span class="font-bold">Aviso:</span> <span id="warningText">No se ha detectado el PDF de TEC4. Si cambias el perfil, asegúrate de que sea correcto.</span></div>
          </div>

          <div id="profileOptionsContainer" class="space-y-3">
            <div class="relative">
              <input type="radio" id="profileOption1" name="studentProfile" value="option1" class="peer hidden">
              <label for="profileOption1"
                     class="flex items-center p-3 bg-white border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-800">
                <div class="w-5 h-5 border-2 border-slate-300 rounded-full flex items-center justify-center mr-3 peer-checked:border-blue-600 peer-checked:bg-blue-600">
                  <div class="w-2 h-2 bg-white rounded-full opacity-0 transition-opacity check-icon"></div>
                </div>
                <span class="font-medium mobile-text-sm">Alumnado CON materias pendientes</span>
              </label>
            </div>
            <div class="relative">
              <input type="radio" id="profileOption2" name="studentProfile" value="option2" class="peer hidden">
              <label for="profileOption2"
                     class="flex items-center p-3 bg-white border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-800">
                <div class="w-5 h-5 border-2 border-slate-300 rounded-full flex items-center justify-center mr-3 peer-checked:border-blue-600 peer-checked:bg-blue-600">
                  <div class="w-2 h-2 bg-white rounded-full opacity-0 transition-opacity check-icon"></div>
                </div>
                <span class="font-medium mobile-text-sm">Repetidor SIN materias pendientes (TEC4)</span>
              </label>
            </div>
            <div class="relative">
              <input type="radio" id="profileOption3" name="studentProfile" value="option3" class="peer hidden">
              <label for="profileOption3"
                     class="flex items-center p-3 bg-white border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-800">
                <div class="w-5 h-5 border-2 border-slate-300 rounded-full flex items-center justify-center mr-3 peer-checked:border-blue-600 peer-checked:bg-blue-600">
                  <div class="w-2 h-2 bg-white rounded-full opacity-0 transition-opacity check-icon"></div>
                </div>
                <span class="font-medium mobile-text-sm">Repetidor CON materias pendientes</span>
              </label>
            </div>
          </div>
        </div>

        <div id="recoveryCriteriaList" class="space-y-3"></div>

        <div id="noFailedCriteriaMessage" class="hidden text-center p-6 md:p-8 bg-green-50 rounded-xl border border-green-200">
          <i class="fa-solid fa-trophy text-4xl text-green-500 mb-3"></i>
          <h3 class="text-lg font-bold text-green-800">¡Todo aprobado!</h3>
          <p class="text-green-600 mobile-text-sm">No se han encontrado criterios suspensos o no evaluados.</p>
        </div>

        <div id="selectedCriterionDetails" class="hidden mt-2 p-4 bg-blue-50 rounded-lg border border-blue-200 space-y-2">
          <p class="text-sm font-semibold text-blue-700">Criterio seleccionado para refuerzo:</p>
          <p id="detailCode" class="text-lg font-bold text-blue-800 font-mono"></p>
          <p id="detailDescription" class="text-sm text-slate-700 text-justify leading-relaxed"></p>
          <p id="detailSource" class="text-xs text-blue-600 font-medium italic"></p>
        </div>
      </div>
    </div>

    <!-- Screen 3 -->
    <div id="screen3" class="hidden flex flex-col items-center justify-center pt-8 md:pt-10">
      <div class="w-full max-w-6xl bg-white/85 rounded-2xl shadow-xl border border-slate-200 p-6 md:p-8 space-y-6">
        <div class="text-center">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-1">Paso 3: Plan de recuperación</h2>
          <p class="text-slate-500 mobile-text-sm">Actividades de refuerzo y recuperación basadas en criterios no superados.</p>
        </div>
        <div id="screen3Content"></div>
      </div>
    </div>

    <!-- Screen 4 -->
    <div id="screen4" class="hidden flex flex-col items-center justify-center pt-8 md:pt-10">
      <div class="w-full max-w-6xl bg-white/85 rounded-2xl shadow-xl border border-slate-200 p-6 md:p-8 space-y-6">
        <div class="text-center">
          <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-1">Paso 4: Otros aspectos a trabajar en el programa</h2>
          <p class="text-slate-500 mobile-text-sm">Selecciona las estrategias, recursos y metodologías para el refuerzo.</p>
        </div>
        <div id="additional-fields-container" class="space-y-4 max-h-[520px] overflow-y-auto pr-1.5"></div>
      </div>
    </div>
  </main>

  <!-- Bottom nav -->
  <div id="bottomNav" class="bottom-nav fixed bottom-0 left-0 right-0 bg-white/90 border-t border-slate-200 z-50 safe-area-bottom shadow-xl">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Screen 1 -->
      <div id="footerButtons1" class="w-full flex justify-end py-1">
        <button onclick="goToScreen(2)" id="nextButton"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 md:px-6 rounded-xl text-base md:text-lg font-semibold transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed mobile-p-3 w-full md:w-auto flex items-center justify-center gap-2"
                disabled>
          Siguiente <i class="fa-solid fa-arrow-right ml-1"></i>
        </button>
      </div>
      <!-- Screen 2 -->
      <div id="footerButtons2" class="w-full flex justify-between items-center hidden py-1">
        <button onclick="goToScreen(1)"
                class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 md:px-6 rounded-xl text-base md:text-lg font-semibold transition-colors shadow-lg mobile-p-3 w-full md:w-auto flex items-center justify-center gap-2">
          <i class="fa-solid fa-arrow-left mr-1"></i> Atrás
        </button>
        <button onclick="goToScreen(3)"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 md:px-6 rounded-xl text-base md:text-lg font-semibold transition-colors shadow-lg mobile-p-3 w-full md:w-auto flex items-center justify-center gap-2">
          Siguiente <i class="fa-solid fa-arrow-right ml-1"></i>
        </button>
      </div>
      <!-- Screen 3 -->
      <div id="footerButtons3" class="w-full flex justify-between items-center hidden py-1">
        <button onclick="goToScreen(2)"
                class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 md:px-6 rounded-xl text-base md:text-lg font-semibold transition-colors shadow-lg mobile-p-3 w-full md:w-auto flex items-center justify-center gap-2">
          <i class="fa-solid fa-arrow-left mr-1"></i> Atrás
        </button>
        <button onclick="goToScreen(4)"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 md:px-6 rounded-xl text-base md:text-lg font-semibold transition-colors shadow-lg mobile-p-3 w-full md:w-auto flex items-center justify-center gap-2">
          Siguiente <i class="fa-solid fa-arrow-right ml-1"></i>
        </button>
      </div>
      <!-- Screen 4 -->
      <div id="footerButtons4" class="w-full flex justify-between items-center hidden py-1">
        <button onclick="goToScreen(3)"
                class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 md:px-6 rounded-xl text-base md:text-lg font-semibold transition-colors shadow-lg mobile-p-3 w-full md:w-auto flex items-center justify-center gap-2">
          <i class="fa-solid fa-arrow-left mr-1"></i> Atrás
        </button>
        <div class="flex gap-2 md:gap-3">
          <button onclick="resetApp()"
                  class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 md:px-6 rounded-xl text-base md:text-lg font-semibold transition-colors shadow-lg flex items-center justify-center gap-2 mobile-p-3 w-full md:w-auto">
            <i class="fa-solid fa-plus"></i> Nuevo alumno
          </button>
          <button onclick="generatePRA()"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 md:px-6 rounded-xl text-base md:text-lg font-semibold transition-colors shadow-lg flex items-center justify-center gap-2 mobile-p-3 w-full md:w-auto">
            <i class="fa-solid fa-wand-magic-sparkles"></i> Generar PRA
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // --- Estado global ---
    let evaluations = [], selectedEvaluationIds = [], currentFilter = 'all', currentScreen = 1,
        selectedRecoveryCriterion = null, consolidatedFailedCriteria = [],
        selectedAdditionalFields = {}, textAreaState = { tareas: '', otros: {} };

    // --- Elementos DOM ---
    const dropZone = document.getElementById('dropZone'),
          fileInput = document.getElementById('fileInput'),
          resultsSection = document.getElementById('resultsSection'),
          loadingState = document.getElementById('loadingState'),
          errorMessage = document.getElementById('errorMessage'),
          errorText = document.getElementById('errorText'),
          tbody = document.getElementById('resultsTableBody'),
          evaluationsListContainer = document.getElementById('evaluationsList'),
          loadedEvaluationsSection = document.getElementById('loadedEvaluationsSection'),
          initialMessage = document.getElementById('initialMessage'),
          nextButton = document.getElementById('nextButton'),
          headerScreenTitle = document.getElementById('headerScreenTitle'),
          screen1 = document.getElementById('screen1'),
          screen2 = document.getElementById('screen2'),
          screen3 = document.getElementById('screen3'),
          screen4 = document.getElementById('screen4'),
          footerButtons1 = document.getElementById('footerButtons1'),
          footerButtons2 = document.getElementById('footerButtons2'),
          footerButtons3 = document.getElementById('footerButtons3'),
          footerButtons4 = document.getElementById('footerButtons4'),
          recoveryCriteriaListContainer = document.getElementById('recoveryCriteriaList'),
          noFailedCriteriaMessage = document.getElementById('noFailedCriteriaMessage'),
          selectedCriterionDetails = document.getElementById('selectedCriterionDetails'),
          detailCode = document.getElementById('detailCode'),
          detailDescription = document.getElementById('detailDescription'),
          detailSource = document.getElementById('detailSource'),
          profileWarning = document.getElementById('profileWarning'),
          screen3Content = document.getElementById('screen3Content'),
          additionalFieldsContainer = document.getElementById('additional-fields-container'),
          bottomNav = document.getElementById('bottomNav');

    // --- Mapeos y datos ---
    const cyrToTec4Mapping = {
      "CYR.3.1.1": ["TEC.4.4.1"], "CYR.3.1.2": ["TEC.4.4.1"], "CYR.3.1.3": ["TEC.4.4.2"],
      "CYR.3.1.4": ["TEC.4.4.1"], "CYR.3.2.1": ["TEC.4.4.2", "TEC.4.3.1"], "CYR.3.2.2": ["TEC.4.4.2", "TEC.4.3.1"],
      "CYR.3.2.3": ["TEC.4.4.2", "TEC.4.3.1"], "CYR.3.3.1": ["TEC.4.4.1", "TEC.4.2.2"], "CYR.3.4.1": ["TEC.4.4.2"],
      "CYR.3.4.2": ["TEC.4.4.2"], "CYR.3.4.3": ["TEC.4.4.2"], "CYR.3.5.1": ["TEC.4.5.1"], "CYR.3.5.2": ["TEC.4.5.1"],
      "CYR.3.6.1": ["TEC.4.6.1"], "CYR.3.6.2": ["TEC.4.6.1"], "CYR.3.6.3": ["TEC.4.6.1"], "CYR.3.6.4": ["TEC.4.6.1"]
    };
    const tydToTec4Mapping = {
      "TYD.3.1.1": ["TEC.4.1.1"], "TYD.3.1.3": ["TEC.4.6.1"], "TYD.3.2.1": ["TEC.4.1.2", "TEC.4.1.3"], "TYD.3.2.2": ["TEC.4.2.2"],
      "TYD.3.3.1": ["TEC.4.2.1", "TEC.4.2.2"], "TYD.3.4.1": ["TEC.4.3.1", "TEC.4.3.2"], "TYD.3.5.1": ["TEC.4.4.1"], "TYD.3.5.2": ["TEC.4.4.2"],
      "TYD.3.5.3": ["TEC.4.4.1"], "TYD.3.6.2": ["TEC.4.5.1"], "TYD.3.6.3": ["TEC.4.5.1"], "TYD.3.7.1": ["TEC.4.6.1", "TEC.4.6.2"],
      "TYD.3.7.2": ["TEC.4.6.3"]
    };
    const allTEC4Criteria = ["TEC.4.1.1","TEC.4.1.2","TEC.4.1.3","TEC.4.2.1","TEC.4.2.2","TEC.4.3.1","TEC.4.3.2","TEC.4.4.1","TEC.4.4.2","TEC.4.5.1","TEC.4.6.1","TEC.4.6.2","TEC.4.6.3"];
    const tec4CriteriaDescriptions = {
      "TEC.4.1.1":"Idear y planificar soluciones tecnológicas emprendedoras que generen un valor para la comunidad, a partir de la observación y el análisis del entorno.",
      "TEC.4.1.2":"Aplicar estrategias colaborativas de gestión de proyectos siguiendo un proceso iterativo de validación, desde la ideación hasta la difusión.",
      "TEC.4.1.3":"Gestionar proyectos de forma creativa con técnicas colaborativas y métodos de investigación para soluciones eficientes e inclusivas.",
      "TEC.4.2.1":"Analizar el diseño de un producto que responda a una necesidad, evaluando demanda y ciclo de vida con criterio ético e inclusivo.",
      "TEC.4.2.2":"Fabricar productos y soluciones aplicando CAD y técnicas manuales, mecánicas y digitales con recursos adecuados.",
      "TEC.4.3.1":"Intercambiar información y fomentar el trabajo en equipo con herramientas digitales y lenguaje técnico adecuado.",
      "TEC.4.3.2":"Presentar y difundir propuestas con buena entonación, expresión, gestión del tiempo y lenguaje inclusivo.",
      "TEC.4.4.1":"Diseñar, construir, controlar y simular sistemas automáticos y robots aplicando conocimientos de control y mecánica/electrónica.",
      "TEC.4.4.2":"Integrar IoT, big data e IA en sistemas tecnológicos con sentido crítico y ético.",
      "TEC.4.5.1":"Resolver tareas con eficiencia usando y configurando aplicaciones y herramientas digitales con autonomía.",
      "TEC.4.6.1":"Usar responsablemente la tecnología aplicando criterios de sostenibilidad y accesibilidad en materiales y procesos.",
      "TEC.4.6.2":"Analizar beneficios de arquitectura bioclimática y ecotransporte para el desarrollo sostenible.",
      "TEC.4.6.3":"Valorar proyectos tecnológicos de carácter social en comunidades abiertas, voluntariado o servicio a la comunidad."
    };
    const additionalFieldsData = {
      "TIPO DE ACTIVIDADES Y TAREAS": ["Tareas (precisar)","Las mismas actividades que sus compañeros/as","Audio","Búsqueda y selección de información en diferentes medios (internet, prensa, libros, etc..)","Confeccionar e interpretar tablas, gráficas, informes, etc.","Elaboración de informes","Exposiciones","Infografía","Maqueta","Mural","Presentaciones","Simulaciones","Toma de apuntes","Vídeo"],
      "FORMAS DE ACCESO A LA INFORMACIÓN": ["Otras (especificar)","Nada que resaltar en este aspecto","Aplicaciones informáticas específicas","Elaborar audios","Elaborar vídeos","Proporcionar acceso a webs","Proporcionar material adicional"],
      "RECURSOS DIDÁCTICOS": ["Otros (especificar)","Nada que reseñar", "Agenda del alumno","Aplicaciones informáticas interactivas que faciliten la comprensión y expresión de los conceptos","Banco de recursos del departamento con diferentes niveles de competencia curricular","Calculadora","Classroom","Cuadernillos alternativos al libro de texto","Gráficos ilustrativos que ayuden a captar y organizar las ideas","Libro de texto ordinario","Libros de consulta","Maquetas realizadas previamente","Móvil","Páginas web informativas sobre los contenidos a trabajar en el aula","Pizarra digital","Recursos audiovisuales (vídeos, audios, fotografías, dibujos, etc.)","Software de aprendizaje, secuencias audiovisuales, enciclopedias en línea","Temporizador/reloj"],
      "AGRUPAMIENTOS, DISTRIBUCIÓN DE ESPACIOS Y TIEMPOS": ["Otros (especificar)","Nada que especificar", "Ajustar la distribución del espacio a las necesidades del aprendizaje","Alternar las actividades académicas con tiempos de descanso (adaptarse a la 'curva de fatiga' del alumno)","Evitar los 'tiempos muertos' en los que el alumno se sienta incómodo o vulnerable","Grupos cooperativos/colaborativos","Priorizar el trabajo de grupo","Priorizar el trabajo individual para centrar su atención y facilitar el seguimiento personalizado","Sentar al alumno cerca del profesor/a y lejos de motivos de distracción","Tutoría entre Iguales"],
      "INSTRUMENTOS DE EVALUACIÓN": ["Otros (especificar)","Los mismos que para sus compañeros","Antes de comenzar, leer el texto en voz alta una vez (ya sea de manera grupal o individual)","Cuidar el formato de los exámenes (claro, limpio)","Dar a conocer las fechas de las pruebas de evaluación con más de una semana de antelación","Disponer de un ejemplo que le facilite la comprensión de lo que tiene que hacer exactamente","En las pruebas escritas, asegurarnos de que ha comprendido el enunciado de todas las preguntas","Evaluar sus progresos en comparación con él mismo","Evitar hacerle copiar los enunciados de las preguntas o problemas en los exámenes","Evitar que el alumno tenga más de una prueba evaluable al día e intentar que estén espaciadas en el tiempo","Fragmentar el texto en pequeñas partes","Permitir que el alumno pueda tener acceso al libro de texto o al material trabajado","Permitir que el alumno pueda tener acceso al material gráfico","Presentar las preguntas del examen por escrito (no dictar)","Proporcionar mayor tiempo para entregas","Reducir el número de preguntas a contestar si son reiterativas","Reducir el número de trabajos","Tiempo adicional en las pruebas de evaluación escritas"]
    };

    // --- Auxiliares ---
    const generateId = () => Math.random().toString(36).substring(2, 9);
    function showError(msg) { errorText.textContent = msg; errorMessage.classList.remove('hidden'); setTimeout(() => errorMessage.classList.add('hidden'), 5000); }

    function getSubjectCode(subject, course) {
      let code = '';
      if ((subject.includes('Tecnología') || subject.includes('TEC')) && (course.includes('4') || course.includes('4º'))) {
        code = 'TEC';
      } else if (subject.includes('Computación') || subject.includes('CYR')) {
        code = 'CYR';
      } else if (subject.includes('Tecnología') || subject.includes('TYD') || subject.includes('Digitalización')) {
        code = 'TYD';
      } else {
        code = subject.substring(0, 3).toUpperCase();
      }
      const courseNum = course.match(/\d+/);
      if (courseNum) {
        code += courseNum[0];
      } else {
        const subjectCourseNum = subject.match(/\d+/);
        if (subjectCourseNum) {
          code += subjectCourseNum[0];
        } else if (code === 'TEC') {
          code += '4';
        }
      }
      return code;
    }

    function getSubjectColorClass(code, course) {
      if (code.startsWith('CYR')) {
        const courseNum = course.match(/\d+/);
        return courseNum ? `cyr-${courseNum[0]}` : 'cyr-1';
      } else if (code.startsWith('TYD')) {
        const courseNum = course.match(/\d+/);
        return courseNum ? `tyd-${courseNum[0]}` : 'tyd-1';
      } else if (code.startsWith('TEC')) {
        return 'tec4';
      }
      return '';
    }

    function getFullSubjectName(subject, course) {
      const code = getSubjectCode(subject, course);
      if (code.startsWith('CYR')) {
        const courseNum = course.match(/\d+/);
        return `Computación y Robótica ${courseNum ? courseNum[0] + 'º' : ''}`;
      } else if (code.startsWith('TYD')) {
        const courseNum = course.match(/\d+/);
        return `Tecnología y Digitalización ${courseNum ? courseNum[0] + 'º' : ''}`;
      } else if (code.startsWith('TEC')) {
        return 'Tecnología 4º';
      }
      return subject;
    }

    function getAccordionClass(code) {
      if (code.startsWith('CYR')) return { header: 'accordion-header-cyr', content: 'accordion-content-cyr' };
      if (code.startsWith('TYD')) return { header: 'accordion-header-tyd', content: 'accordion-content-tyd' };
      if (code.startsWith('TEC')) return { header: 'accordion-header-tec4', content: 'accordion-content-tec4' };
      return { header: '', content: '' };
    }

    function saveTextAreaState() {
      const tareasElem = document.getElementById('tareas-text');
      if (tareasElem) textAreaState.tareas = tareasElem.value;
      for (const section in additionalFieldsData) {
        const textareaId = `otros-${section.replace(/\s+/g, '-')}`;
        const textarea = document.getElementById(textareaId);
        if (textarea) textAreaState.otros[section] = textarea.value;
      }
      try { localStorage.setItem('textAreaState', JSON.stringify(textAreaState)); } catch {}
    }
    function restoreTextAreaState() {
      try {
        const saved = localStorage.getItem('textAreaState');
        if (saved) textAreaState = JSON.parse(saved);
      } catch {}
      const tareasElem = document.getElementById('tareas-text');
      if (tareasElem && textAreaState.tareas) tareasElem.value = textAreaState.tareas;
      for (const section in textAreaState.otros) {
        const textareaId = `otros-${section.replace(/\s+/g, '-')}`;
        const textarea = document.getElementById(textareaId);
        if (textarea && textAreaState.otros[section]) textarea.value = textAreaState.otros[section];
      }
    }
    function setupTextAreaEvents() {
      const tareasTextarea = document.getElementById('tareas-text');
      if (tareasTextarea) tareasTextarea.addEventListener('input', function () { textAreaState.tareas = this.value; });
      for (const section in additionalFieldsData) {
        const textareaId = `otros-${section.replace(/\s+/g, '-')}`;
        const textarea = document.getElementById(textareaId);
        if (textarea) textarea.addEventListener('input', function () { textAreaState.otros[section] = this.value; });
      }
    }
    function toggleAccordion(button) {
      const content = button.nextElementSibling;
      const icon = button.querySelector('i');
      content.classList.toggle('hidden');
      icon.classList.toggle('rotate-180');
    }
    function selectRecoveryCriterion(element, criterion) {
      document.querySelectorAll('.recovery-criterion-item').forEach(i => i.classList.remove('selected'));
      element.classList.add('selected');
      selectedRecoveryCriterion = criterion;
      detailCode.textContent = `Código: ${criterion.code}`;
      detailDescription.textContent = criterion.description;
      detailSource.textContent = `Materia de origen: ${criterion.source}`;
      selectedCriterionDetails.classList.remove('hidden');
    }

    function checkForTech4() { return evaluations.some(e => (e.course.includes('4') || e.course.includes('4º')) && (e.subject.toLowerCase().includes('tecnología') || e.subject.toUpperCase().includes('TEC'))); }
    function checkLowerCourses() { return evaluations.some(e => e.course.match(/[123](?:º)?/i)); }
    function determineStudentProfile() { const hasTech4 = checkForTech4(), hasLower = checkLowerCourses(); if (hasTech4 && !hasLower) return 'profileOption2'; if (hasTech4 && hasLower) return 'profileOption3'; return 'profileOption1'; }
    function updateWarningState() { profileWarning.classList.toggle('hidden', checkForTech4()); }
    function getSelectedProfile() { const radios = document.querySelectorAll('input[name="studentProfile"]'); for (let r of radios) if (r.checked) return r.id; return 'profileOption1'; }
    function getSelectedEvaluationsData() { return evaluations.filter(e => selectedEvaluationIds.includes(e.id)); }
    function getEvaluationHash(data) { let hash = data.student.toLowerCase().trim() + "|" + data.subject.toLowerCase().trim(); data.criteria.forEach(c => { hash += `|${c.code}_${c.grade}`; }); return hash; }

    function getPRAType() {
      const profile = getSelectedProfile();
      switch (profile) {
        case 'profileOption1': return "PRA de PENdientes";
        case 'profileOption2': return "PRA de REPetición";
        case 'profileOption3': return "PRA de PENdientes y REPetición";
        default: return "PRA";
      }
    }
    function getProgramType() {
      const profile = getSelectedProfile();
      switch (profile) {
        case 'profileOption1': return "Alumnado CON materias pendientes";
        case 'profileOption2': return "Repetidor SIN materias pendientes (TEC4)";
        case 'profileOption3': return "Repetidor CON materias pendientes";
        default: return "No especificado";
      }
    }

    // --- Modales ---
    function showHelp() { document.getElementById('helpModal').classList.remove('hidden'); }
    function closeHelp() { document.getElementById('helpModal').classList.add('hidden'); }
    function showValidationModal(message) { document.getElementById('validationMessage').innerHTML = message; document.getElementById('validationModal').classList.remove('hidden'); }
    function closeValidationModal() { document.getElementById('validationModal').classList.add('hidden'); }

    // --- Navegación entre pantallas ---
    function goToScreen(screenNumber) {
      if (currentScreen === 4) saveTextAreaState();
      currentScreen = screenNumber;
      [screen1, screen2, screen3, screen4].forEach(s => s.classList.add('hidden'));
      [footerButtons1, footerButtons2, footerButtons3, footerButtons4].forEach(f => f.classList.add('hidden'));
      const screens = {
        1: [screen1, footerButtons1, "Paso 1: Carga y Consolidación"],
        2: [screen2, footerButtons2, "Paso 2: Plan de Mejora"],
        3: [screen3, footerButtons3, "Paso 3: Plan de Recuperación"],
        4: [screen4, footerButtons4, "Paso 4: Otros Aspectos a Trabajar"]
      };
      if (screens[screenNumber]) {
        const [screen, footer, title] = screens[screenNumber];
        screen.classList.remove('hidden'); footer.classList.remove('hidden'); headerScreenTitle.textContent = title;
        if (screenNumber === 1) {
          const hasSelected = getSelectedEvaluationsData().length > 0;
          nextButton.disabled = !hasSelected;
        } else if (screenNumber === 2) {
          if (getSelectedEvaluationsData().length === 0) { showError("Debes cargar y seleccionar al menos un informe PDF."); goToScreen(1); return; }
          consolidatedFailedCriteria = getConsolidatedFailedCriteria(); renderScreen2();
        } else if (screenNumber === 3) {
          if (getSelectedEvaluationsData().length === 0) { showError("Debes cargar y seleccionar al menos un informe PDF."); goToScreen(1); return; }
          renderScreen3();
        } else if (screenNumber === 4) {
          if (getSelectedEvaluationsData().length === 0) { showError("Debes cargar y seleccionar al menos un informe PDF."); goToScreen(1); return; }
          loadAdditionalFields(); setTimeout(() => { restoreTextAreaState(); setupTextAreaEvents(); }, 100);
        }
      }
      showBottomNavTemporarily();
    }

    // --- Bottom nav behaviour ---
    let navHideTimeout;
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    function initBottomNav() {
      if (isMobile) { bottomNav.classList.add('always-visible'); return; }
      document.addEventListener('mousemove', (e) => {
        if (window.innerHeight - e.clientY < 100) {
          showBottomNav(); clearTimeout(navHideTimeout); navHideTimeout = setTimeout(hideBottomNav, 2000);
        }
      });
      let lastScrollTop = 0;
      window.addEventListener('scroll', () => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        if (scrollTop > lastScrollTop) showBottomNavTemporarily();
        lastScrollTop = scrollTop;
      });
      hideBottomNav();
    }
    function showBottomNav() { if (!isMobile) bottomNav.classList.add('visible'); }
    function hideBottomNav() { if (!isMobile) bottomNav.classList.remove('visible'); }
    function showBottomNavTemporarily() { if (!isMobile) { showBottomNav(); clearTimeout(navHideTimeout); navHideTimeout = setTimeout(hideBottomNav, 2000); } }
    document.addEventListener('click', (e) => {
      if (e.target.closest('#bottomNav')) { showBottomNav(); clearTimeout(navHideTimeout); navHideTimeout = setTimeout(hideBottomNav, 2000); }
    });

    // --- Manejo de archivos y PDF ---
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault(); dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) handleFiles(files);
    });
    fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFiles(e.target.files); });

    function handleFiles(files) {
      errorMessage.classList.add('hidden'); loadingState.classList.remove('hidden');
      const fileArray = Array.from(files);
      const processFilesSequentially = async () => {
        for (const file of fileArray) { await handleFile(file); }
        loadingState.classList.add('hidden');
      };
      processFilesSequentially().catch(error => {
        console.error('Error procesando archivos:', error);
        loadingState.classList.add('hidden');
        showError('Error al procesar archivos: ' + error.message);
      });
      fileInput.value = '';
    }

    async function handleFile(file) {
      if (file.type !== 'application/pdf') { showError(`Ignorando archivo "${file.name}": Tipo no soportado.`); return; }
      try {
        const arrayBuffer = await file.arrayBuffer();
        const extractedData = await processPDF(arrayBuffer);
        if (extractedData.criteria.length === 0) { showError(`No se pudieron extraer criterios válidos del archivo "${file.name}".`); return; }
        if (evaluations.length > 0) {
          const firstStudent = evaluations[0].student.toLowerCase().trim(), newStudent = extractedData.student.toLowerCase().trim();
          if (firstStudent !== newStudent) {
            showError(`Error: Solo se permite consolidar evaluaciones del mismo alumno. La primera evaluación cargada es de "${evaluations[0].student}", y esta es de "${extractedData.student}".`);
            return;
          }
        }
        const uniqueHash = getEvaluationHash(extractedData);
        if (evaluations.some(e => e.uniqueHash === uniqueHash)) { showError(`Advertencia: La evaluación de "${extractedData.subject}" ya ha sido cargada (archivo: ${file.name}).`); return; }
        const newEvaluation = { id: generateId(), fileName: file.name, ...extractedData, uniqueHash };
        evaluations.push(newEvaluation);
        selectedEvaluationIds = [newEvaluation.id];
        updateLoadedEvaluationsUI(); renderSelectedResults();
      } catch (error) {
        console.error('Error procesando archivo:', error);
        showError(`Error al procesar "${file.name}": ${error.message || 'Error desconocido'}`);
      }
    }

    async function processPDF(arrayBuffer) {
      if (typeof pdfjsLib === 'undefined') throw new Error('PDF.js no se cargó correctamente');
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let allItems = [], cumulativeHeight = 0;
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const viewport = page.getViewport({ scale: 1.0 });
        textContent.items.forEach(item => {
          if (!item.str.trim()) return;
          const pageY = viewport.height - item.transform[5];
          const globalY = cumulativeHeight + pageY;
          allItems.push({ str: item.str, x: item.transform[4], pageY, globalY, w: item.width, h: item.height, page: i });
        });
        cumulativeHeight += viewport.height;
      }
      return parseData(allItems);
    }

    function parseData(allItems) {
      allItems.sort((a, b) => { if (Math.abs(a.globalY - b.globalY) > 4) return a.globalY - b.globalY; return a.x - b.x; });

      let studentName = "", subject = "", course = "Desconocido";
      const headerItems = allItems.filter(i => i.page === 1 && i.pageY < 400);
      let currentLineY = -1, currentLineStr = "", cleanHeaderLines = [];
      headerItems.forEach(item => {
        if (Math.abs(item.globalY - currentLineY) > 5) { if (currentLineStr) cleanHeaderLines.push(currentLineStr); currentLineStr = item.str; currentLineY = item.globalY; }
        else { currentLineStr += " " + item.str; }
      });
      cleanHeaderLines.push(currentLineStr);
      const headerStoppers = ["Fecha","Unidad","Año","Área"];
      cleanHeaderLines.forEach(line => {
        if (line.includes("Alumno/a:")) {
          let rawValue = line.split("Alumno/a:")[1];
          let cutIndex = rawValue.length;
          headerStoppers.forEach(stopper => { const idx = rawValue.indexOf(stopper); if (idx !== -1 && idx < cutIndex) cutIndex = idx; });
          studentName = rawValue.substring(0, cutIndex).replace(/[,.\-]$/, '').trim();
        }
        if (line.includes("Área / Materia:")) {
          let rawValue = line.split("Área / Materia:")[1];
          let cutIndex = rawValue.length;
          headerStoppers.forEach(stopper => { const idx = rawValue.indexOf(stopper); if (idx !== -1 && idx < cutIndex) cutIndex = idx; });
          subject = rawValue.substring(0, cutIndex).trim();
        }
        if (line.includes("Curso:")) {
          const match = line.match(/Curso:\s*(.*?)(?=\s*(Fecha|$))/i);
          if (match && match[1]) {
            course = match[1].trim();
            if (!course.toUpperCase().includes('E.S.O.')) {
              const courseNumMatch = course.match(/\d+º/);
              if (courseNumMatch) course = courseNumMatch[0] + " E.S.O.";
            }
          }
        }
      });

      const codeRegex = /^(TYD|CYR|TEC|DIG)\s*\.\s*(\d+)\s*\.\s*(\d+)\s*\.\s*(\d+)/i;
      const codeItems = allItems.filter(i => codeRegex.test(i.str.trim()));
      const criteriaLeftAlignX = codeItems.length > 0 ? (() => {
        const xValues = codeItems.map(i => i.x).sort((a, b) => a - b);
        return xValues[Math.floor(xValues.length / 2)] - 10;
      })() : 220;

      const criteriaBlocks = [];
      const gradeCandidates = [];
      const gradeMinX = 480;
      const gradeRegex = /^\s*\d{1,2}([.,]\d{1,2})?\s*$/;
      const forbiddenPhrases = ["Fecha de generación","Pág.:","Cód.Centro","Ref.Doc.","Junta de Andalucía","Consejería","I.E.S.","INFORME DE EVALUACIÓN","Año académico","Unidad","Alumno/a:","Curso:","Fecha desde:","Fecha hasta:","Área / Materia:","COMPETENCIAS ESPECÍFICAS","VALOR","CRITERIOS DE EVALUACIÓN","CALIFICACIÓN","Criterios de Evaluación","Calificación"];

      let currentBlock = null;
      allItems.forEach(item => {
        const txt = item.str.trim();
        if (item.page > 1 && item.pageY < 180) return;
        if (item.pageY < 50) return;
        if (forbiddenPhrases.some(phrase => txt.includes(phrase))) return;

        if (item.x >= gradeMinX) {
          if (gradeRegex.test(txt)) gradeCandidates.push({ val: txt.replace(/\s/g, ''), globalY: item.globalY, used: false });
          return;
        }
        if (item.x < criteriaLeftAlignX) return;
        const match = txt.match(codeRegex);
        if (match) {
          if (currentBlock) currentBlock.endGlobalY = item.globalY;
          let rawCode = match[0];
          let cleanCode = rawCode.replace(/\s/g, '');
          let desc = txt.substring(match.index + rawCode.length).trim().replace(/^[\s.\-–]+/, '').trim();
          currentBlock = { code: cleanCode, courseNum: match[2], desc, startGlobalY: item.globalY, endGlobalY: null };
          criteriaBlocks.push(currentBlock);
        } else if (currentBlock) {
          currentBlock.desc += " " + txt;
        }
      });
      if (currentBlock) currentBlock.endGlobalY = 999999;
      criteriaBlocks.forEach(block => {
        const validGrade = gradeCandidates.find(g => !g.used && g.globalY >= (block.startGlobalY - 15) && g.globalY < block.endGlobalY);
        block.grade = validGrade ? validGrade.val : "No evaluado";
        if (validGrade) validGrade.used = true;
      });
      if (course === "Desconocido" && criteriaBlocks.length > 0) course = criteriaBlocks[0].courseNum + "º E.S.O.";

      return {
        student: studentName || "Desconocido",
        subject: subject || "Desconocida",
        course,
        criteria: criteriaBlocks.map(c => ({ code: c.code, courseNum: c.courseNum, description: c.desc.replace(/\s+/g, ' ').trim(), grade: c.grade }))
      };
    }

    // --- UI y selección ---
    function toggleEvaluationSelection(id) {
      const index = selectedEvaluationIds.indexOf(id);
      if (index > -1) selectedEvaluationIds.splice(index, 1);
      else selectedEvaluationIds.push(id);
      updateLoadedEvaluationsUI(); renderSelectedResults();
    }

    function updateLoadedEvaluationsUI() {
      evaluations.sort((a, b) => {
        const courseA = parseInt(a.course.replace(/\D/g, '')) || 99;
        const courseB = parseInt(b.course.replace(/\D/g, '')) || 99;
        if (courseA !== courseB) return courseA - courseB;
        return a.subject.localeCompare(b.subject);
      });

      evaluationsListContainer.innerHTML = '';
      document.getElementById('evalCount').textContent = evaluations.length;

      if (evaluations.length === 0) {
        loadedEvaluationsSection.classList.add('hidden');
        initialMessage.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        nextButton.disabled = true;
        return;
      }

      loadedEvaluationsSection.classList.remove('hidden');
      initialMessage.classList.add('hidden');
      nextButton.disabled = selectedEvaluationIds.length === 0;

      evaluations.forEach(evalItem => {
        const isSelected = selectedEvaluationIds.includes(evalItem.id);
        const colorClass = getSubjectColorClass(getSubjectCode(evalItem.subject, evalItem.course), evalItem.course);
        const div = document.createElement('div');
        div.className = `evaluation-item p-3 cursor-pointer border-l-4 border-white hover:border-blue-300 transition-all ${isSelected ? 'selected' : ''} ${colorClass}`;
        div.setAttribute('data-id', evalItem.id);
        div.innerHTML = `
          <div class="flex justify-between items-center group">
            <div class="truncate pr-2 flex-grow" onclick="toggleEvaluationSelection('${evalItem.id}')">
              <p class="font-semibold text-slate-800 truncate" title="${evalItem.subject} - ${evalItem.course}">${evalItem.subject} - ${evalItem.course}</p>
              <p class="text-xs text-slate-500 truncate mt-1">Archivo: ${evalItem.fileName}</p>
              <p class="text-xs text-slate-400 truncate">Alumno: ${evalItem.student}</p>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="event.stopPropagation(); deleteEvaluation('${evalItem.id}')" class="text-slate-400 hover:text-red-600 transition-colors p-1 rounded-full hover:bg-red-50" title="Eliminar evaluación">
                <i class="fa-solid fa-trash-can"></i>
              </button>
              <div class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center ${isSelected ? 'bg-blue-600' : 'bg-slate-200'}" onclick="toggleEvaluationSelection('${evalItem.id}')">
                <i class="fa-solid fa-check text-xs ${isSelected ? 'text-white' : 'text-slate-600'}"></i>
              </div>
            </div>
          </div>
        `;
        evaluationsListContainer.appendChild(div);
      });
    }

    function filterCriteria(filterType, button) {
      currentFilter = filterType;
      document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
      if (button) button.classList.add('active');
      renderSelectedResults();
    }

    function renderSelectedResults() {
      const selectedData = getSelectedEvaluationsData();
      if (selectedData.length === 0) {
        resultsSection.classList.add('hidden');
        initialMessage.classList.remove('hidden');
        nextButton.disabled = true;
        return;
      }

      initialMessage.classList.add('hidden'); resultsSection.classList.remove('hidden'); nextButton.disabled = false;

      const studentName = evaluations.length > 0 ? evaluations[0].student : 'Desconocido';
      const subjects = [...new Set(selectedData.map(e => e.subject))];
      const courses = [...new Set(selectedData.map(e => e.course))];

      document.getElementById('currentSelectionCount').textContent = `${selectedData.length} Materia${selectedData.length > 1 ? 's' : ''}`;
      document.getElementById('resName').textContent = studentName;
      document.getElementById('resSubject').textContent = subjects.join(', ') || 'Ninguna seleccionada';
      document.getElementById('resCourse').textContent = courses.join(', ') || 'Desconocido';

      let consolidatedCriteria = [];
      selectedData.forEach(evalItem => {
        const source = `${evalItem.subject}`;
        evalItem.criteria.forEach(c => {
          consolidatedCriteria.push({ ...c, source, student: evalItem.student, subject: evalItem.subject, course: evalItem.course });
        });
      });

      let filteredCriteria = consolidatedCriteria;
      switch (currentFilter) {
        case 'approved':
          filteredCriteria = consolidatedCriteria.filter(c => { const g = parseFloat(c.grade.replace(',', '.')); return !isNaN(g) && g >= 5; });
          break;
        case 'failed':
          filteredCriteria = consolidatedCriteria.filter(c => { const g = parseFloat(c.grade.replace(',', '.')); return !isNaN(g) && g < 5; });
          break;
        case 'unevaluated':
          filteredCriteria = consolidatedCriteria.filter(c => c.grade === "No evaluado");
          break;
      }

      filteredCriteria.sort((a, b) => {
        const getWeight = (code) => code.startsWith('CYR') ? 1 : code.startsWith('TYD') ? 2 : code.startsWith('TEC') ? 3 : 4;
        const weightA = getWeight(a.code), weightB = getWeight(b.code);
        if (weightA !== weightB) return weightA - weightB;
        const courseA = parseInt(a.courseNum) || 0;
        const courseB = parseInt(b.courseNum) || 0;
        if (courseA !== courseB) return courseA - courseB;
        return a.code.localeCompare(b.code);
      });

      document.getElementById('criteriaCount').textContent = getCriteriaCountText(filteredCriteria);
      tbody.innerHTML = '';

      if (filteredCriteria.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-slate-500">No se encontraron criterios para esta selección y filtro.</td></tr>`;
        return;
      }

      filteredCriteria.forEach(c => {
        const tr = document.createElement('tr');
        const colorClass = getSubjectColorClass(c.code, c.course);
        tr.className = `hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0 ${colorClass}`;
        let gradeColor = "text-slate-400", gradeDisplay = "-";
        if (c.grade && c.grade !== "No evaluado") {
          gradeDisplay = c.grade;
          let gradeVal = parseFloat(c.grade.replace(',', '.'));
          gradeColor = gradeVal < 5 ? "text-rose-600 font-bold" : "text-emerald-600 font-bold";
        } else if (c.grade === "No evaluado") {
          gradeDisplay = c.grade; gradeColor = "text-slate-600 font-medium";
        }
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap font-mono text-sm text-blue-700 font-bold align-top">${c.code}</td>
          <td class="px-6 py-4 text-slate-700 align-top text-sm leading-relaxed text-justify">${c.description}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right align-top ${gradeColor} text-base">${gradeDisplay}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function getCriteriaCountText(filteredCriteria) {
      const count = filteredCriteria.length, noun = count === 1 ? 'Criterio' : 'Criterios';
      let filterNameDisplay;
      switch (currentFilter) {
        case 'approved': filterNameDisplay = count === 1 ? 'Aprobado' : 'Aprobados'; break;
        case 'failed': filterNameDisplay = count === 1 ? 'Suspenso' : 'Suspensos'; break;
        case 'unevaluated': filterNameDisplay = count === 1 ? 'No Evaluado' : 'No Evaluados'; break;
        default: filterNameDisplay = 'Todos'; break;
      }
      return `${count} ${noun} (${filterNameDisplay})`;
    }

    // --- Pantalla 2 ---
    function getConsolidatedFailedCriteria() {
      const selectedData = getSelectedEvaluationsData();
      if (selectedData.length === 0) return new Map();
      let allCriteria = [];
      selectedData.forEach(evalItem => {
        evalItem.criteria.forEach(c => {
          allCriteria.push({ ...c, source: `${evalItem.subject} (${evalItem.course})`, id: c.code + '_' + evalItem.subject });
        });
      });
      const failedCriteria = allCriteria.filter(c => {
        const g = parseFloat(c.grade.replace(',', '.'));
        return (c.grade === "No evaluado" || (isNaN(g) || g < 5)) && !c.code.startsWith('TEC.4');
      });
      const groups = new Map();
      failedCriteria.forEach(c => { if (!groups.has(c.source)) groups.set(c.source, []); groups.get(c.source).push(c); });
      return groups;
    }

    function renderScreen2() {
      recoveryCriteriaListContainer.innerHTML = '';
      selectedCriterionDetails.classList.add('hidden'); selectedRecoveryCriterion = null;
      const defaultOptionId = determineStudentProfile();
      document.querySelectorAll('input[name="studentProfile"]').forEach(radio => {
        radio.onchange = null; radio.addEventListener('change', updateWarningState); radio.checked = (radio.id === defaultOptionId);
      });
      updateWarningState();
      const criteriaByGroup = getConsolidatedFailedCriteria();
      const selectedProfile = getSelectedProfile();

      if (selectedProfile === 'profileOption2') {
        noFailedCriteriaMessage.classList.remove('hidden');
        noFailedCriteriaMessage.innerHTML = `
          <i class="fa-solid fa-info-circle text-4xl text-blue-500 mb-3"></i>
          <h3 class="text-lg font-bold text-blue-800">Repetidor SIN materias pendientes</h3>
          <p class="text-blue-600 mobile-text-sm">No se mostrarán criterios de cursos anteriores. En la siguiente pantalla se definirán los criterios de TEC4 a reforzar.</p>
        `;
        return;
      }
      if (criteriaByGroup.size === 0) {
        noFailedCriteriaMessage.classList.remove('hidden');
        noFailedCriteriaMessage.innerHTML = `
          <i class="fa-solid fa-trophy text-4xl text-green-500 mb-3"></i>
          <h3 class="text-lg font-bold text-green-800">¡Todo aprobado!</h3>
          <p class="text-green-600 mobile-text-sm">No se han encontrado criterios suspensos o no evaluados en la selección actual.</p>
        `;
        return;
      }
      noFailedCriteriaMessage.classList.add('hidden');

      const sortedGroups = Array.from(criteriaByGroup.keys()).sort();
      sortedGroups.forEach((groupName, index) => {
        const criteriaList = criteriaByGroup.get(groupName);
        criteriaList.sort((a, b) => a.code.localeCompare(b.code));
        const firstCriterion = criteriaList[0];
        const accordionClass = getAccordionClass(firstCriterion.code);

        const accordionItem = document.createElement('div');
        accordionItem.className = `border border-slate-200 rounded-xl overflow-hidden shadow-sm`;

        const headerButton = document.createElement('button');
        headerButton.className = `flex justify-between items-center w-full p-4 ${accordionClass.header} hover:bg-slate-200 transition-colors font-bold text-slate-700 text-base`;
        headerButton.setAttribute('onclick', 'toggleAccordion(this)');
        headerButton.innerHTML = `
          <span class="mobile-text-sm">${groupName}
            <span class="text-sm font-normal text-slate-500 ml-2">(${criteriaList.length} criterios)</span>
          </span>
          <i class="fa-solid fa-chevron-down text-sm transition-transform duration-300 ${index === 0 ? '' : 'rotate-180'}"></i>
        `;

        const contentDiv = document.createElement('div');
        contentDiv.className = `divide-y divide-slate-100 ${index === 0 ? '' : 'hidden'} ${accordionClass.content}`;

        criteriaList.forEach(c => {
          const criterionDiv = document.createElement('div');
          criterionDiv.className = 'recovery-criterion-item p-4 cursor-pointer hover:bg-blue-50 border-l-4 border-transparent hover:border-blue-500 transition-all';
          criterionDiv.innerHTML = `
            <div class="flex justify-between">
              <span class="font-mono text-sm font-bold text-blue-700">${c.code}</span>
              <span class="text-xs font-semibold ${c.grade === 'No evaluado' ? 'text-slate-600' : 'text-rose-600'}">${c.grade}</span>
            </div>
            <p class="text-xs text-slate-600 mt-1 truncate">${c.description}</p>
          `;
          criterionDiv.onclick = () => selectRecoveryCriterion(criterionDiv, c);
          contentDiv.appendChild(criterionDiv);
        });

        accordionItem.appendChild(headerButton);
        accordionItem.appendChild(contentDiv);
        recoveryCriteriaListContainer.appendChild(accordionItem);
      });
    }

    // --- Pantalla 3 ---
    function getConsolidatedFailedCriteriaList() {
      const selectedData = getSelectedEvaluationsData();
      let allFailedCriteria = [];
      selectedData.forEach(evalItem => {
        evalItem.criteria.forEach(c => {
          const g = parseFloat(c.grade.replace(',', '.'));
          if (c.grade === "No evaluado" || (isNaN(g) || g < 5)) {
            allFailedCriteria.push({ ...c, subject: evalItem.subject, course: evalItem.course });
          }
        });
      });
      return allFailedCriteria;
    }

    function getRelatedTEC4Criteria(failedCriteria) {
      const relatedTEC4 = new Set();
      failedCriteria.forEach(criterion => {
        const code = criterion.code;
        if (code.startsWith('CYR')) {
          const normalizedCode = code.replace(/^(CYR\.)\d+(\.)/, '$13$2');
          if (cyrToTec4Mapping[normalizedCode]) cyrToTec4Mapping[normalizedCode].forEach(tec4 => relatedTEC4.add(tec4));
        }
        if (code.startsWith('TYD')) {
          const normalizedCode = code.replace(/^(TYD\.)\d+(\.)/, '$13$2');
          if (tydToTec4Mapping[normalizedCode]) tydToTec4Mapping[normalizedCode].forEach(tec4 => relatedTEC4.add(tec4));
        }
      });
      return Array.from(relatedTEC4).sort();
    }

    function groupCriteriaByCourseAndSubject(failedCriteria) {
      const grouped = {};
      failedCriteria.forEach(criterion => {
        const course = criterion.course, subject = criterion.subject;
        if (!grouped[course]) grouped[course] = {};
        if (!grouped[course][subject]) grouped[course][subject] = [];
        grouped[course][subject].push(criterion);
      });
      return grouped;
    }

    function renderScreen3() {
      const profile = getSelectedProfile();
      const failedCriteria = getConsolidatedFailedCriteriaList();
      let contentHTML = '';

      switch (profile) {
        case 'profileOption2':
          const allTEC4HTML = allTEC4Criteria.map(code => `
            <div class="criterion-node tec4">
              <span class="font-mono font-bold">${code}</span>
              <p class="text-sm text-slate-700 mt-1">${tec4CriteriaDescriptions[code] || 'Descripción no disponible'}</p>
            </div>
          `).join('');
          contentHTML = `
            <div class="text-center mb-6">
              <p class="text-lg font-semibold text-slate-700 mobile-text-sm">El/la alumno/a tendrá que reforzar todos los criterios de la materia TEC4</p>
            </div>
            <div class="border border-slate-200 rounded-xl overflow-hidden">
              <button class="flex justify-between items-center w-full p-4 accordion-header-tec4 hover:bg-slate-200 transition-colors font-bold text-slate-700" onclick="toggleAccordion(this)">
                <span class="mobile-text-sm">Criterios de TEC4 a reforzar (${allTEC4Criteria.length} criterios)</span>
                <i class="fa-solid fa-chevron-down transition-transform"></i>
              </button>
              <div class="accordion-content hidden p-4 accordion-content-tec4">${allTEC4HTML}</div>
            </div>
          `;
          break;

        case 'profileOption3':
          const relatedTEC4 = getRelatedTEC4Criteria(failedCriteria);
          let tec4ListHTML = relatedTEC4.length > 0 ? relatedTEC4.map(code => `
            <div class="criterion-node tec4">
              <span class="font-mono font-bold">${code}</span>
              <p class="text-sm text-slate-700 mt-1">${tec4CriteriaDescriptions[code] || 'Descripción no disponible'}</p>
            </div>
          `).join('') : '<p class="text-slate-600 mobile-text-sm">No se encontraron criterios de TEC4 relacionados.</p>';
          contentHTML = `
            <div class="text-center mb-6">
              <p class="text-lg font-semibold text-slate-700 mobile-text-sm">El/la alumno/a reforzará los siguientes criterios de TEC4, con posibles actividades adicionales.</p>
            </div>
            <div class="border border-slate-200 rounded-xl overflow-hidden">
              <button class="flex justify-between items-center w-full p-4 accordion-header-tec4 hover:bg-slate-200 transition-colors font-bold text-slate-700" onclick="toggleAccordion(this)">
                <span class="mobile-text-sm">Criterios de TEC4 a reforzar</span>
                <i class="fa-solid fa-chevron-down transition-transform"></i>
              </button>
              <div class="accordion-content hidden p-4 accordion-content-tec4">${tec4ListHTML}</div>
            </div>
          `;
          break;

        case 'profileOption1':
        default:
          const groupedCriteria = groupCriteriaByCourseAndSubject(failedCriteria);
          let accordionsHTML = '';
          if (Object.keys(groupedCriteria).length === 0) {
            accordionsHTML = '<p class="text-slate-600 text-center py-4 mobile-text-sm">No se encontraron criterios no superados.</p>';
          } else {
            Object.keys(groupedCriteria).sort().forEach(course => {
              Object.keys(groupedCriteria[course]).sort().forEach(subject => {
                const criteria = groupedCriteria[course][subject];
                const firstCriterion = criteria[0];
                const accordionClass = getAccordionClass(firstCriterion.code);
                const criteriaHTML = criteria.map(criterion => `
                  <div class="criterion-node ${accordionClass.content.replace('accordion-content-', '')}">
                    <span class="font-mono font-bold">${criterion.code}</span>
                    <p class="text-sm text-slate-700 mt-1">${criterion.description}</p>
                  </div>
                `).join('');
                accordionsHTML += `
                  <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <button class="flex justify-between items-center w-full p-4 ${accordionClass.header} hover:bg-slate-200 transition-colors font-bold text-slate-700" onclick="toggleAccordion(this)">
                      <span class="mobile-text-sm">${subject} - ${course}</span>
                      <i class="fa-solid fa-chevron-down transition-transform"></i>
                    </button>
                    <div class="accordion-content hidden p-4 ${accordionClass.content}">${criteriaHTML}</div>
                  </div>
                `;
              });
            });
          }
          contentHTML = `
            <div class="text-center mb-6">
              <p class="text-lg font-semibold text-slate-700 mobile-text-sm">El/la alumno/a realizará una secuencia de actividades para superar los criterios siguientes:</p>
            </div>
            <div class="space-y-4">${accordionsHTML}</div>
          `;
          break;
      }
      screen3Content.innerHTML = contentHTML;
    }

    // --- Pantalla 4 ---
    function loadAdditionalFields() {
      const container = document.getElementById('additional-fields-container');
      container.innerHTML = '';

      const sectionClasses = {
        "TIPO DE ACTIVIDADES Y TAREAS": "section-actividades",
        "FORMAS DE ACCESO A LA INFORMACIÓN": "section-acceso",
        "RECURSOS DIDÁCTICOS": "section-recursos",
        "AGRUPAMIENTOS, DISTRIBUCIÓN DE ESPACIOS Y TIEMPOS": "section-agrupamientos",
        "INSTRUMENTOS DE EVALUACIÓN": "section-evaluacion"
      };
      const sectionIcons = {
        "TIPO DE ACTIVIDADES Y TAREAS": "clipboard-list",
        "FORMAS DE ACCESO A LA INFORMACIÓN": "book-open",
        "RECURSOS DIDÁCTICOS": "package",
        "AGRUPAMIENTOS, DISTRIBUCIÓN DE ESPACIOS Y TIEMPOS": "users",
        "INSTRUMENTOS DE EVALUACIÓN": "file-check"
      };

      for (const [section, items] of Object.entries(additionalFieldsData)) {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = `additional-field-section ${sectionClasses[section]}`;

        let itemsHTML = items.map(item => {
          if (item === "Otros (especificar)" || item === "Otras (especificar)") {
            const textareaId = `otros-${section.replace(/\s+/g, '-')}`;
            const isChecked = selectedAdditionalFields[section] && selectedAdditionalFields[section].includes(item);
            const showClass = isChecked ? 'show' : '';
            return `
              <div class="additional-field-item">
                <input type="checkbox" id="${section}-${item.replace(/\s+/g, '-')}" value="${item}" onchange="toggleOtrosTextarea('${section}', this)" ${isChecked ? 'checked' : ''}>
                <label for="${section}-${item.replace(/\s+/g, '-')}" class="text-sm text-slate-700 cursor-pointer flex-1 mobile-text-sm">${item}</label>
              </div>
              <div id="${textareaId}-container" class="otros-textarea-container ${showClass}">
                <textarea id="${textareaId}" rows="3" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none mobile-text-sm" placeholder="Especifica otros aspectos...">${isChecked ? (textAreaState.otros[section] || '') : ''}</textarea>
              </div>
            `;
          } else if (item === "Tareas (precisar)") {
            const isChecked = selectedAdditionalFields[section] && selectedAdditionalFields[section].includes(item);
            const showClass = isChecked ? 'show' : '';
            return `
              <div class="additional-field-item">
                <input type="checkbox" id="${section}-${item.replace(/\s+/g, '-')}" value="${item}" onchange="toggleTareasTextarea(this)" ${isChecked ? 'checked' : ''}>
                <label for="${section}-${item.replace(/\s+/g, '-')}" class="text-sm text-slate-700 cursor-pointer flex-1 mobile-text-sm">${item}</label>
              </div>
              <div id="tareas-textarea-container" class="tareas-textarea-container ${showClass}">
                <textarea id="tareas-text" rows="3" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none mobile-text-sm" placeholder="Describe las tareas específicas...">${isChecked ? (textAreaState.tareas || '') : ''}</textarea>
              </div>
            `;
          } else {
            const isChecked = selectedAdditionalFields[section] && selectedAdditionalFields[section].includes(item);
            return `
              <div class="additional-field-item">
                <input type="checkbox" id="${section}-${item.replace(/\s+/g, '-')}" value="${item}" onchange="updateAdditionalField('${section}', this)" ${isChecked ? 'checked' : ''}>
                <label for="${section}-${item.replace(/\s+/g, '-')}" class="text-sm text-slate-700 cursor-pointer flex-1 mobile-text-sm">${item}</label>
              </div>
            `;
          }
        }).join('');

        sectionDiv.innerHTML = `
          <h3 class="font-semibold mb-3 flex items-center gap-2 mobile-text-sm">
            <i class="fa-solid fa-${sectionIcons[section]}"></i>${section}
          </h3>
          <div class="space-y-2">${itemsHTML}</div>
        `;
        container.appendChild(sectionDiv);
      }
      setTimeout(() => setupTextAreaEvents(), 100);
    }

    function toggleTareasTextarea(checkbox) {
      const textareaContainer = document.getElementById('tareas-textarea-container');
      const textarea = document.getElementById('tareas-text');
      if (checkbox.checked) { textareaContainer.classList.add('show'); if (textAreaState.tareas) textarea.value = textAreaState.tareas; }
      else { textareaContainer.classList.remove('show'); textarea.value = ''; textAreaState.tareas = ''; }
      updateAdditionalField('TIPO DE ACTIVIDADES Y TAREAS', checkbox);
    }
    function toggleOtrosTextarea(section, checkbox) {
      const textareaId = `otros-${section.replace(/\s+/g, '-')}`;
      const textareaContainer = document.getElementById(`${textareaId}-container`);
      const textarea = document.getElementById(textareaId);
      if (checkbox.checked) { textareaContainer.classList.add('show'); if (textAreaState.otros[section]) textarea.value = textAreaState.otros[section]; }
      else { textareaContainer.classList.remove('show'); textarea.value = ''; delete textAreaState.otros[section]; }
      updateAdditionalField(section, checkbox);
    }
    function updateAdditionalField(section, checkbox) {
      if (!selectedAdditionalFields[section]) selectedAdditionalFields[section] = [];
      if (checkbox.checked) selectedAdditionalFields[section].push(checkbox.value);
      else selectedAdditionalFields[section] = selectedAdditionalFields[section].filter(item => item !== checkbox.value);
    }

    // --- Detección automática repetidor ---
    function isRepeater() { const hasTech4 = checkForTech4(); const hasLowerCourses = checkLowerCourses(); return hasTech4 && hasLowerCourses; }

    // --- Validación ---
    function validateAdditionalFields() {
      const requiredSections = [
        "TIPO DE ACTIVIDADES Y TAREAS",
        "FORMAS DE ACCESO A LA INFORMACIÓN",
        "RECURSOS DIDÁCTICOS",
        "AGRUPAMIENTOS, DISTRIBUCIÓN DE ESPACIOS Y TIEMPOS",
        "INSTRUMENTOS DE EVALUACIÓN"
      ];
      const emptySections = [];
      for (const section of requiredSections) {
        if (!selectedAdditionalFields[section] || selectedAdditionalFields[section].length === 0) emptySections.push(section);
      }
      if (emptySections.length === 0) return true;
      let msg = "";
      if (emptySections.length === 1) {
        msg = `Se han marcado 0 ítems en <strong>${emptySections[0]}</strong>. Seleccione al menos un check en la misma.`;
      } else {
        msg = "Se han marcado 0 ítems en las siguientes subsecciones:<br>" +
          emptySections.map(s => `• <strong>${s}</strong>`).join('<br>') +
          "<br><br>Marque al menos un ítem en cada una de ellas";
      }
      showValidationModal(msg);
      return false;
    }

    // --- Exportación y generación ---
    function generatePRA() {
      if (!validateAdditionalFields()) return;
      try {
        saveTextAreaState();
        if (typeof jspdf === 'undefined') { alert('Error: La librería para generar PDF no está cargada correctamente. Recarga la página e intenta nuevamente.'); return; }
        const { jsPDF } = jspdf, doc = new jsPDF(),
              studentName = evaluations.length > 0 ? evaluations[0].student : "Desconocido",
              profile = getSelectedProfile(),
              failedCriteria = getConsolidatedFailedCriteriaList(),
              selectedData = getSelectedEvaluationsData(),
              subjectCodes = selectedData.map(e => getSubjectCode(e.subject, e.course));

        let codes = [...new Set(subjectCodes)];
        if (isRepeater()) {
          codes = codes.map(code => (code === 'TYD4' || code === 'CYR4') ? 'REP' : code);
          if (!codes.includes('REP')) codes.push('REP');
        }
        const studentSafe = (evaluations.length > 0 ? evaluations[0].student : 'Desconocido').replace(/[^a-z0-9]/gi, '_');
        let fileName = `PRA`;
        const subjectPart = codes.join('_');
        if (subjectPart) fileName += `_${subjectPart}`;
        fileName += `_${studentSafe}.pdf`;
        fileName = fileName.replace(/_+/g, '_');

        // PDF header
        doc.setFillColor(37, 99, 235); doc.rect(0, 0, 210, 20, 'F');
        doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("PROGRAMA DE REFUERZO DEL APRENDIZAJE", 105, 13, { align: "center" });
        doc.setTextColor(0, 0, 0); doc.setFontSize(11); doc.setFont("helvetica", "normal");

        let y = 35, pageHeight = 280, margin = 14, maxWidth = 180, lineHeight = 7;
        function checkPageBreak(h) { if (y + h > pageHeight) { doc.addPage(); y = 20; return true; } return false; }
        function addText(text, isBold = false, customY = null, customMaxWidth = maxWidth) {
          const currentY = customY !== null ? customY : y;
          doc.setFont("helvetica", isBold ? "bold" : "normal");
          const safeText = text ? String(text) : '', lines = doc.splitTextToSize(safeText, customMaxWidth), textHeight = lines.length * lineHeight;
          if (currentY + textHeight > pageHeight) { doc.addPage(); y = 20; addText(text, isBold, y, customMaxWidth); return y + textHeight + 5; }
          doc.text(lines, margin, currentY);
          return currentY + textHeight + 5;
        }
        function addSection(title, content) {
          checkPageBreak(15); doc.setFont("helvetica", "bold"); doc.text(title, margin, y);
          doc.setDrawColor(200, 200, 200); doc.line(margin, y+1, 196, y+1);
          y += 10; y = addText(content || '', false, y); return y;
        }

        const praType = getPRAType();
        const programType = getProgramType();
        const subjectsWithCourse = selectedData.map(e => `${e.subject} (${e.course})`);
        const uniqueSubjectsWithCourse = [...new Set(subjectsWithCourse)];

        y = addSection("DATOS DEL ALUMNO/A", `Nombre: ${studentName}\nTipo de programa: ${programType}\nMaterias: ${uniqueSubjectsWithCourse.join(', ')}`);
        y = addSection("TIPO DE PRA", `${praType}`);

        if (profile === 'profileOption1' || profile === 'profileOption3') {
          let criteriaText = "";
          const groupedCriteria = groupCriteriaByCourseAndSubject(failedCriteria);
          Object.keys(groupedCriteria).sort().forEach(course => {
            Object.keys(groupedCriteria[course]).sort().forEach(subject => {
              if (profile === 'profileOption3' && course.includes('4')) return;
              const criteria = groupedCriteria[course][subject];
              const subjectCode = getSubjectCode(subject, course);
              const fullSubjectName = getFullSubjectName(subject, course);
              criteriaText += `${fullSubjectName} (${subjectCode}): ${criteria.map(c => c.code).join(", ")}\n\n`;
            });
          });
          if (criteriaText) {
            checkPageBreak(20); doc.setFont("helvetica", "bold"); doc.text("CRITERIOS A SUPERAR", margin, y);
            doc.setDrawColor(200, 200, 200); doc.line(margin, y+1, 196, y+1); y += 8; doc.setFont("helvetica", "normal");
            const lines = criteriaText.split('\n');
            lines.forEach(line => { if (line.trim()) { y = addText(line, false, y); y += 2; } });
          }
        }

        checkPageBreak(20); doc.setFillColor(220, 252, 231); doc.rect(margin, y-5, 182, 10, 'F');
        doc.setTextColor(21, 128, 61); doc.setFont("helvetica", "bold"); doc.text("PROPUESTA DE REFUERZO", 105, y+1, { align: "center" });
        y += 15; doc.setTextColor(0, 0, 0); doc.setFont("helvetica", "normal");

        if (profile === 'profileOption2') {
          let texto = "El alumno/a cursa TEC4 y repite curso. Se trabajarán todos los criterios de Tecnología 4º.\n\nSe podrán proponer actividades adicionales que desarrollen los criterios:";
          y = addText(texto);
          allTEC4Criteria.forEach(id => {
            checkPageBreak(25); const desc = tec4CriteriaDescriptions[id];
            doc.setFont("helvetica", "bold"); doc.text(id, margin, y); doc.setFont("helvetica", "normal");
            const descLines = doc.splitTextToSize(desc, 160), descHeight = descLines.length * lineHeight;
            if (y + descHeight > pageHeight) { doc.addPage(); y = 20; }
            doc.text(descLines, 35, y); y += descHeight + 4;
          });
        } else if (profile === 'profileOption3') {
          const relatedTEC4 = getRelatedTEC4Criteria(failedCriteria);
          let texto = "Criterios de Tecnología 4º a reforzar en base a las materias del departamento no superadas.\n\nSe podrán proponer actividades adicionales a lo largo del curso:";
          y = addText(texto);
          if (relatedTEC4.length === 0) { y = addText("No se han detectado criterios específicos correlacionados."); }
          else {
            relatedTEC4.forEach(id => {
              checkPageBreak(25); const desc = tec4CriteriaDescriptions[id];
              doc.setFont("helvetica", "bold"); doc.text(id, margin, y); doc.setFont("helvetica", "normal");
              const descLines = doc.splitTextToSize(desc, 160), descHeight = descLines.length * lineHeight;
              if (y + descHeight > pageHeight) { doc.addPage(); y = 20; }
              doc.text(descLines, 35, y); y += descHeight + 4;
            });
          }
        } else {
          let texto = "El/la alumno/a deberá realizar actividades para superar los criterios no superados del Departamento.\n\nLa entrega se realizará en Classroom del Departamento.\n\nSe proporcionará una evaluación pormenorizada por criterio.";
          y = addText(texto);
          const groupedCriteria = groupCriteriaByCourseAndSubject(failedCriteria);
          Object.keys(groupedCriteria).sort().forEach(course => {
            Object.keys(groupedCriteria[course]).sort().forEach(subject => {
              checkPageBreak(15);
              const subjectCode = getSubjectCode(subject, course);
              const fullSubjectName = getFullSubjectName(subject, course);
              doc.setFont("helvetica", "bold"); doc.text(`${fullSubjectName} (${subjectCode})`, margin, y); y += 7;
              const criteria = groupedCriteria[course][subject], codes = criteria.map(c => c.code).join(", ");
              checkPageBreak(10); doc.setFont("helvetica", "normal"); doc.text(codes, margin, y, { maxWidth: 180 }); y += lineHeight * 2; y += 5;
            });
          });
        }

        if (Object.keys(selectedAdditionalFields).length > 0) {
          checkPageBreak(20); y += 10;
          doc.setFillColor(240, 249, 255); doc.rect(margin, y-5, 182, 10, 'F');
          doc.setTextColor(37, 99, 235); doc.setFont("helvetica", "bold");
          doc.text("OTROS ASPECTOS A TRABAJAR EN EL PROGRAMA", 105, y+1, { align: "center" });
          y += 15; doc.setTextColor(0, 0, 0);

          for (const [section, items] of Object.entries(selectedAdditionalFields)) {
            checkPageBreak(15); doc.setFont("helvetica", "bold"); doc.text(section, margin, y); y += 7;
            if (items.length === 0) { doc.setFont("helvetica", "italic"); y = addText("No se han seleccionado elementos específicos.", false, y); }
            else {
              doc.setFont("helvetica", "normal");

              if (section === "TIPO DE ACTIVIDADES Y TAREAS") {
                if (items.includes("Tareas (precisar)") && textAreaState.tareas) {
                  checkPageBreak(10); doc.text("Tareas específicas:", margin, y); y += lineHeight;
                  const lines = textAreaState.tareas.split('\n').filter(l => l.trim());
                  let n = 1; lines.forEach(line => { checkPageBreak(10); doc.text(`${n}) ${line.trim()}`, margin + 10, y); y += lineHeight; n++; });
                  y += 5;
                }
                let normal = false;
                items.forEach(item => {
                  if (!["Otros (especificar)","Otras (especificar)","Tareas (precisar)"].includes(item)) {
                    checkPageBreak(10); doc.text(`- ${item}`, margin, y); y += lineHeight; normal = true;
                  }
                });
                if (normal) y += 5;
                if ((items.includes("Otros (especificar)") || items.includes("Otras (especificar)")) && textAreaState.otros[section]) {
                  checkPageBreak(10); doc.text("Otros aspectos:", margin, y); y += lineHeight;
                  const lines = textAreaState.otros[section].split('\n').filter(l => l.trim());
                  let n = 1; lines.forEach(line => { checkPageBreak(10); doc.text(`${n}) ${line.trim()}`, margin + 10, y); y += lineHeight; n++; });
                  y += 5;
                }
              } else {
                let normal = false;
                items.forEach(item => {
                  if (!["Otros (especificar)","Otras (especificar)","Tareas (precisar)"].includes(item)) {
                    checkPageBreak(10); doc.text(`- ${item}`, margin, y); y += lineHeight; normal = true;
                  }
                });
                if (normal) y += 5;
                if ((items.includes("Otros (especificar)") || items.includes("Otras (especificar)")) && textAreaState.otros[section]) {
                  checkPageBreak(10); doc.text("Otros aspectos:", margin, y); y += lineHeight;
                  const lines = textAreaState.otros[section].split('\n').filter(l => l.trim());
                  let n = 1; lines.forEach(line => { checkPageBreak(10); doc.text(`${n}) ${line.trim()}`, margin + 10, y); y += lineHeight; n++; });
                  y += 5;
                }
              }
            }
            doc.setDrawColor(200, 200, 200); doc.line(margin, y, 196, y); y += 10;
          }
        }

        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i); doc.setFontSize(8); doc.setTextColor(150);
          doc.text("Generado automáticamente por ISUStoPRA - Dpto. Tecnología", 105, 290, { align: "center" });
          doc.text(`Página ${i} de ${pageCount}`, 105, 285, { align: "center" });
        }
        doc.save(fileName);
      } catch (error) {
        console.error('Error al generar PRA:', error);
        alert('Error al generar el PDF: ' + error.message);
      }
    }

    // --- Limpieza de textareas y checks en pantalla 4 (solución al problema de “Nuevo alumno”) ---
    function clearAdditionalTextAreas() {
      // Vaciar y ocultar el textarea de "Tareas (precisar)"
      const tareasContainer = document.getElementById('tareas-textarea-container');
      const tareasText = document.getElementById('tareas-text');
      if (tareasText) tareasText.value = '';
      if (tareasContainer) tareasContainer.classList.remove('show');

      // Vaciar y ocultar todos los "Otros (especificar)" por sección
      const otrosTextareas = additionalFieldsContainer
        ? additionalFieldsContainer.querySelectorAll('textarea[id^="otros-"]')
        : [];
      otrosTextareas.forEach(tx => {
        tx.value = '';
        const parentContainer = document.getElementById(`${tx.id}-container`);
        if (parentContainer) parentContainer.classList.remove('show');
      });

      // Desmarcar todos los checkboxes de las secciones adicionales
      const checkboxes = additionalFieldsContainer
        ? additionalFieldsContainer.querySelectorAll('input[type="checkbox"]')
        : [];
      checkboxes.forEach(cb => { cb.checked = false; });
    }

    function resetApp() {
      if (!confirm("¿Estás seguro de que quieres reiniciar todos los datos y comenzar con un nuevo alumno?")) return;

      // Estado lógico
      evaluations = [];
      selectedEvaluationIds = [];
      currentFilter = 'all';
      consolidatedFailedCriteria = [];
      selectedAdditionalFields = {};
      textAreaState = { tareas: '', otros: {} };
      localStorage.removeItem('textAreaState');

      // Estado visual de pantalla 4
      clearAdditionalTextAreas();
      if (additionalFieldsContainer) {
        additionalFieldsContainer.innerHTML = '';
      }

      // UI general
      updateLoadedEvaluationsUI();
      initialMessage.classList.remove('hidden');
      resultsSection.classList.add('hidden');
      nextButton.disabled = true;

      // Volver al paso 1
      goToScreen(1);
    }

    function deleteEvaluation(id) {
      evaluations = evaluations.filter(e => e.id !== id);
      selectedEvaluationIds = selectedEvaluationIds.filter(sid => sid !== id);
      updateLoadedEvaluationsUI(); renderSelectedResults();
      if (evaluations.length === 0) clearAllData();
    }

    function clearAllData() {
      // Estado lógico
      evaluations = [];
      selectedEvaluationIds = [];
      currentFilter = 'all';
      consolidatedFailedCriteria = [];
      selectedAdditionalFields = {};
      textAreaState = { tareas: '', otros: {} };
      localStorage.removeItem('textAreaState');

      // Estado visual de pantalla 4
      clearAdditionalTextAreas();
      if (additionalFieldsContainer) {
        additionalFieldsContainer.innerHTML = '';
      }

      // UI general
      updateLoadedEvaluationsUI();
      initialMessage.classList.remove('hidden');
      resultsSection.classList.add('hidden');
      nextButton.disabled = true;
    }

    // --- Export helpers ---
    function getFilterName() {
      switch (currentFilter) {
        case 'approved': return 'Aprobados';
        case 'failed': return 'Suspensos';
        case 'unevaluated': return 'NoEvaluados';
        default: return 'Todos';
      }
    }

    function getFileName(ext) {
      const selectedData = getSelectedEvaluationsData();
      if (selectedData.length === 0) return `sin_datos.${ext}`;
      const student = evaluations.length > 0 ? evaluations[0].student.replace(/[^a-z0-9]/gi, '_') : 'Desconocido';
      const subjectCodes = selectedData.map(e => getSubjectCode(e.subject, e.course));
      let uniqueSubjectCodes = [...new Set(subjectCodes)];
      if (isRepeater()) {
        uniqueSubjectCodes = uniqueSubjectCodes.map(code => (code === 'TYD4' || code === 'CYR4') ? 'REP' : code);
        if (!uniqueSubjectCodes.includes('REP')) uniqueSubjectCodes.push('REP');
      }
      uniqueSubjectCodes = uniqueSubjectCodes.filter(code => code && code.trim() !== '');
      const subjectPart = uniqueSubjectCodes.join('_');
      const filterNameWithPrefix = `CCEE_${getFilterName()}`;
      let fileName = `${student}`;
      if (subjectPart) fileName += `_${subjectPart}`;
      fileName += `_${filterNameWithPrefix}.${ext}`;
      return fileName.replace(/_+/g, '_');
    }

    function getFilteredCriteriaForExport() {
      const selectedData = getSelectedEvaluationsData();
      if (selectedData.length === 0) return [];
      let consolidated = [];
      selectedData.forEach(evalItem => {
        evalItem.criteria.forEach(c => consolidated.push({ ...c, student: evalItem.student, subject: evalItem.subject, course: evalItem.course }));
      });
      let filtered = [];
      switch (currentFilter) {
        case 'approved':
          filtered = consolidated.filter(c => { const g = parseFloat(c.grade.replace(',', '.')); return !isNaN(g) && g >= 5; });
          break;
        case 'failed':
          filtered = consolidated.filter(c => { const g = parseFloat(c.grade.replace(',', '.')); return !isNaN(g) && g < 5; });
          break;
        case 'unevaluated':
          filtered = consolidated.filter(c => c.grade === "No evaluado");
          break;
        default: filtered = consolidated; break;
      }
      filtered.sort((a, b) => a.code.localeCompare(b.code));
      return filtered;
    }

    function exportJSON() {
      const selectedData = getSelectedEvaluationsData();
      if (selectedData.length === 0) { showError('No hay evaluaciones seleccionadas para exportar.'); return; }
      const criteria = getFilteredCriteriaForExport();
      const data = {
        metadata: {
          alumno: evaluations.length > 0 ? evaluations[0].student : 'Desconocido',
          materias: [...new Set(selectedData.map(e => e.subject))],
          cursos: [...new Set(selectedData.map(e => e.course))],
          archivos_origen: selectedData.map(e => e.fileName),
          filtro_aplicado: getFilterName()
        },
        criteria: criteria.map(c => ({ materia: c.subject, codigo: c.code, descripcion: c.description, calificacion: c.grade }))
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = getFileName('json'); document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function exportCSV() {
      const selectedData = getSelectedEvaluationsData();
      if (selectedData.length === 0) { showError('No hay evaluaciones seleccionadas para exportar.'); return; }
      const criteria = getFilteredCriteriaForExport();
      const filterName = getFilterName();
      let csv = "Materia;Código;Descripción;Calificación;Alumno;Curso;Filtro_Aplicado\n";
      const esc = (text) => text ? '"' + String(text).replace(/"/g, '""') + '"' : "";
      criteria.forEach(c => {
        const row = [esc(c.subject), esc(c.code), esc(c.description), esc(c.grade), esc(c.student), esc(c.course), esc(filterName)];
        csv += row.join(";") + "\n";
      });
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = getFileName('csv'); document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // --- Inicialización ---
    window.addEventListener('load', function () {
      if (typeof pdfjsLib === 'undefined') { console.error('PDF.js no se cargó'); showError('Error: La librería PDF.js no se cargó correctamente. Recarga la página.'); }
      if (typeof jspdf === 'undefined') { console.error('jsPDF no se cargó'); showError('Error: La librería jsPDF no se cargó correctamente. Recarga la página.'); }
      initBottomNav();
    });

    document.addEventListener('DOMContentLoaded', () => {
      textAreaState = { tareas: '', otros: {} }; selectedAdditionalFields = {}; localStorage.removeItem('textAreaState');
      goToScreen(1); updateLoadedEvaluationsUI();
      const allButton = document.getElementById('filterAll');
      if (allButton) allButton.classList.add('active');
    });
  </script>
	<script>
	if ('serviceWorker' in navigator) {
	  navigator.serviceWorker.register('/sw.js')
		.then(reg => console.log('SW registrado', reg))
		.catch(err => console.error('Error SW', err));
	}
	</script>

</body>
</html>
